FROM golang:1.16-alpine as builder
WORKDIR /pesakit
COPY . .
RUN go clean -modcache
RUN go mod tidy
RUN go mod download
RUN cd cmd && go build -o pesakit

FROM alpine:latest
LABEL name="pesakit - commandline tool for mobile payment api"
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /pesakit ./
ARG PK_AIRTEL_BASE_URL
ARG PK_AIRTEL_PUBKEY
ARG PK_AIRTEL_DISBURSE_PIN
ARG PK_AIRTEL_CLIENT_ID
ARG PK_AIRTEL_CLIENT_SECRET
ARG PK_DEBUG_MODE
ARG PK_AIRTEL_DEPLOYMENT
ARG PK_AIRTEL_CALLBACK_AUTH
ARG PK_AIRTEL_CALLBACK_PRIVKEY
ARG PK_AIRTEL_COUNTRIES
ARG PK_AIRTEL_AUTH_ENDPOINT
ARG PK_AIRTEL_PUSH_ENDPOINT
ARG PK_AIRTEL_REFUND_ENDPOINT
ARG PK_AIRTEL_PUSH_ENQUIRY_ENDPOINT
ARG PK_AIRTEL_DISBURSE_ENDPOINT
ARG PK_AIRTEL_DISBURSE_ENQUIRY_ENDPOINT
ARG PK_AIRTEL_SUMMARY_ENDPOINT
ARG PK_AIRTEL_BALANCE_ENDPOINT
ARG PK_AIRTEL_USER_ENDPOINT
ARG PK_MPESA_AUTH_ENDPOINT
ARG PK_MPESA_PUSH_ENDPOINT
ARG PK_MPESA_DISBURSE_ENDPOINT
ARG PK_MPESA_BASE_URL
ARG PK_MPESA_APP_NAME
ARG PK_MPESA_APP_DESCRIPTION
ARG PK_MPESA_API_KEY
ARG PK_MPESA_PUBLIC_KEY
ARG PK_MPESA_SESSION_LIFETIME_MINUTES
ARG PK_MPESA_SERVICE_PROVIDER_CODE
ARG PK_MPESA_TRUSTED_SOURCES
ARG PK_TIGO_DISBURSE_PIN
ARG PK_TIGO_DISBURSE_URL
ARG PK_TIGO_DISBURSE_BRAND_ID
ARG PK_TIGO_DISBURSE_ACCOUNT_MSISDN
ARG PK_TIGO_DISBURSE_ACCOUNT_NAME
ARG PK_TIGO_PUSH_USERNAME
ARG PK_TIGO_PUSH_PASSWORD
ARG PK_TIGO_PUSH_BILLER_CODE
ARG PK_TIGO_PUSH_BILLER_MSISDN
ARG PK_TIGO_PUSH_BASE_URL
ARG PK_TIGO_PUSH_TOKEN_URL
ARG PK_TIGO_PUSH_PAY_URL
ARG PK_TIGO_PASSWORD_GRANT_TYPE

ENV PK_AIRTEL_BASE_URL $PK_AIRTEL_BASE_URL
ENV PK_AIRTEL_PUBKEY $PK_AIRTEL_PUBKEY
ENV PK_AIRTEL_DISBURSE_PIN $PK_AIRTEL_DISBURSE_PIN
ENV PK_AIRTEL_CLIENT_ID $PK_AIRTEL_CLIENT_ID
ENV PK_AIRTEL_CLIENT_SECRET $PK_AIRTEL_CLIENT_SECRET
ENV PK_DEBUG_MODE $PK_DEBUG_MODE
ENV PK_AIRTEL_DEPLOYMENT $PK_AIRTEL_DEPLOYMENT
ENV PK_AIRTEL_CALLBACK_AUTH $PK_AIRTEL_CALLBACK_AUTH
ENV PK_AIRTEL_CALLBACK_PRIVKEY $PK_AIRTEL_CALLBACK_PRIVKEY
ENV PK_AIRTEL_COUNTRIES $PK_AIRTEL_COUNTRIES
ENV PK_AIRTEL_AUTH_ENDPOINT $PK_AIRTEL_AUTH_ENDPOINT
ENV PK_AIRTEL_PUSH_ENDPOINT $PK_AIRTEL_PUSH_ENDPOINT
ENV PK_AIRTEL_REFUND_ENDPOINT $PK_AIRTEL_REFUND_ENDPOINT
ENV PK_AIRTEL_PUSH_ENQUIRY_ENDPOINT $PK_AIRTEL_PUSH_ENQUIRY_ENDPOINT
ENV PK_AIRTEL_DISBURSE_ENDPOINT $PK_AIRTEL_DISBURSE_ENDPOINT
ENV PK_AIRTEL_DISBURSE_ENQUIRY_ENDPOINT $PK_AIRTEL_DISBURSE_ENQUIRY_ENDPOINT
ENV PK_AIRTEL_SUMMARY_ENDPOINT $PK_AIRTEL_SUMMARY_ENDPOINT
ENV PK_AIRTEL_BALANCE_ENDPOINT $PK_AIRTEL_BALANCE_ENDPOINT
ENV PK_AIRTEL_USER_ENDPOINT $PK_AIRTEL_USER_ENDPOINT
ENV PK_MPESA_AUTH_ENDPOINT $PK_MPESA_AUTH_ENDPOINT
ENV PK_MPESA_PUSH_ENDPOINT $PK_MPESA_PUSH_ENDPOINT
ENV PK_MPESA_DISBURSE_ENDPOINT $PK_MPESA_DISBURSE_ENDPOINT
ENV PK_MPESA_BASE_URL $PK_MPESA_BASE_URL
ENV PK_MPESA_APP_NAME $PK_MPESA_APP_NAME
ENV PK_MPESA_APP_DESCRIPTION $PK_MPESA_APP_DESCRIPTION
ENV PK_MPESA_API_KEY $PK_MPESA_API_KEY
ENV PK_MPESA_PUBLIC_KEY $PK_MPESA_PUBLIC_KEY
ENV PK_MPESA_SESSION_LIFETIME_MINUTES $PK_MPESA_SESSION_LIFETIME_MINUTES
ENV PK_MPESA_SERVICE_PROVIDER_CODE $PK_MPESA_SERVICE_PROVIDER_CODE
ENV PK_MPESA_TRUSTED_SOURCES $PK_MPESA_TRUSTED_SOURCES
ENV PK_TIGO_DISBURSE_PIN $PK_TIGO_DISBURSE_PIN
ENV PK_TIGO_DISBURSE_URL $PK_TIGO_DISBURSE_URL
ENV PK_TIGO_DISBURSE_BRAND_ID $PK_TIGO_DISBURSE_BRAND_ID
ENV PK_TIGO_DISBURSE_ACCOUNT_MSISDN $PK_TIGO_DISBURSE_ACCOUNT_MSISDN
ENV PK_TIGO_DISBURSE_ACCOUNT_NAME $PK_TIGO_DISBURSE_ACCOUNT_NAME
ENV PK_TIGO_PUSH_USERNAME $PK_TIGO_PUSH_USERNAME
ENV PK_TIGO_PUSH_PASSWORD $PK_TIGO_PUSH_PASSWORD
ENV PK_TIGO_PUSH_BILLER_CODE $PK_TIGO_PUSH_BILLER_CODE
ENV PK_TIGO_PUSH_BILLER_MSISDN $PK_TIGO_PUSH_BILLER_MSISDN
ENV PK_TIGO_PUSH_BASE_URL $PK_TIGO_PUSH_BASE_URL
ENV PK_TIGO_PUSH_TOKEN_URL $PK_TIGO_PUSH_TOKEN_URL
ENV PK_TIGO_PUSH_PAY_URL $PK_TIGO_PUSH_PAY_URL
ENV PK_TIGO_PASSWORD_GRANT_TYPE $BP_TIGO_PASSWORD_GRANT_TYPE

CMD ["cmd/pesakit"]